<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Hello</title>
	<link rel="stylesheet" href="css/app.css">

	<!-- todo: concat scripts -->
	<script src="/js/react/react.js"></script>
	<script src="/js/react/JSXTransformer.js"></script>
	<script src="/js/jquery/jquery.min.js"></script>
	<script src="/js/showdown/showdown.js"></script>
</head>
<body data-csrf="<%= _csrf %>">
	<div id="content"></div>

	<script type="text/jsx">
	/**
	 * @jsx React.DOM
	 */
	// The above declaration must remain intact at the top of the script.
	// Your code here

	// tutorial 6
	var converter = new Showdown.converter();

	// tutorial 5
	var Comment = React.createClass({
		render: function () {
			// tutorial 7
			var rawMarkup = converter.makeHtml(this.props.children.toString());

			return (
				<div className="comment">
					<h2 className="commentAuthor">
						{this.props.author}
					</h2>
					<span dangerouslySetInnerHTML={{__html: rawMarkup}} />
				</div>
			);
		}
	});

	// tutorial 2
	var CommentList = React.createClass({
		render: function () {
			var commentNodes = this.props.data.map(function (comment) {
				return <Comment author={comment.author}>{comment.text}</Comment>
			});

			return (
				<div className="commentList">
					{commentNodes}
				</div>
			);
		}
	});

	var CommentForm = React.createClass({
		handleSubmit: function (e) {
			e.preventDefault();

			var author = this.refs.author.getDOMNode().value.trim();
			var text = this.refs.text.getDOMNode().value.trim();
			var csrf = $('body').data('csrf');

			if (!text || !author) {
				return false;
			}

			this.props.onCommentSubmit({author: author, text: text, _csrf: csrf});
			this.refs.text.getDOMNode().value = '';
			this.refs.text.getDOMNode().focus();
		},

		render: function () {
			return (
				<form className="commentForm" onSubmit={this.handleSubmit}>
					<input type="text" placeholder="Your name" ref="author" />
					<input type="text" placeholder="Say something..." ref="text" />
					<input type="submit" value="Post" />
				</form>
			);
		}
	});

	// tutorial 1
	var CommentBox = React.createClass({
		loadCommentsFromServer: function () {
			$.ajax({
				url: this.props.url,
				dataType: 'json',
				success: function (data) {
					this.setState({data: data});
				}.bind(this),
				error: function (xhr, status, err) {
					console.error(this.props.url, status, err.toString());
				}.bind(this)
			});
		},

		handleCommentSubmit: function (comment) {
			// tutorial 20
			var comments = this.state.data;
			var newComments = comments.concat([comment]);
			this.setState({data: newComments});

			// tutorial 19
			$.ajax({
				url: this.props.url,
				dataType: 'json',
				type: 'POST',
				data: comment,
				success: function (data) {
					this.setState({data: data});
				}.bind(this),
				error: function (err) {
					console.error(this.props.url, status, err.toString());
				}.bind(this)
			});
		},

		getInitialState: function () {
			return {data: []};
		},

		componentWillMount: function () {
			this.loadCommentsFromServer();
			setInterval(this.loadCommentsFromServer, this.props.pollInterval);
		},

		render: function() {
			return (
				<div className="commentBox">
					<h1>Comments</h1>
					<CommentList data={this.state.data} />
					<CommentForm onCommentSubmit={this.handleCommentSubmit} />
				</div>
			);
		}
	});

	React.renderComponent(
		<CommentBox url="comments.json" pollInterval={2000} />,
		document.getElementById('content')
	);
	</script>
</body>
</html>
